base_hero = class ({})
LinkLuaModifier("base_hero_mod", "_basics/base_hero_mod", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_general_script", "_bot_scripts/_general_script", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_fountain_refresh_hp", "_modifiers/generics/_fountain_refresh_hp", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_fountain_refresh_mp", "_modifiers/generics/_fountain_refresh_mp", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_avoid_damage", "_modifiers/generics/_modifier_avoid_damage", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_ban", "_modifiers/generics/_modifier_ban", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_barrier", "_modifiers/generics/_modifier_barrier", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_barrier_universal_efx", "_modifiers/generics/_modifier_barrier_universal_efx", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_bkb", "_modifiers/generics/_modifier_bkb", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_blind", "_modifiers/generics/_modifier_blind", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_blind_stack", "_modifiers/generics/_modifier_blind_stack", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_break", "_modifiers/generics/_modifier_break", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_disarm", "_modifiers/generics/_modifier_disarm", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_ethereal", "_modifiers/generics/_modifier_ethereal", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_ethereal_status_efx", "_modifiers/generics/_modifier_ethereal_status_efx", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_fear", "_modifiers/generics/_modifier_fear", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_fear_status_efx", "_modifiers/generics/_modifier_fear_status_efx", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_force_attack", "_modifiers/generics/_modifier_force_attack", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_generic_arc", "_modifiers/generics/_modifier_generic_arc", LUA_MODIFIER_MOTION_BOTH)
LinkLuaModifier("_modifier_generic_custom_indicator", "_modifiers/generics/_modifier_generic_custom_indicator", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_generic_knockback_lua", "_modifiers/generics/_modifier_generic_knockback_lua", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_hex", "_modifiers/generics/_modifier_hex", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_hide", "_modifiers/generics/_modifier_hide", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_immunity", "_modifiers/generics/_modifier_immunity", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_invi_level", "_modifiers/generics/_modifier_invi_level", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_invisible", "_modifiers/generics/_modifier_invisible", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_invulnerable", "_modifiers/generics/_modifier_invulnerable", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_lighting", "_modifiers/generics/_modifier_lighting", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_no_bar", "_modifiers/generics/_modifier_no_bar", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_mute", "_modifiers/generics/_modifier_mute", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_no_block", "_modifiers/generics/_modifier_no_block", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_no_vision_attacker", "_modifiers/generics/_modifier_no_vision_attacker", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_path", "_modifiers/generics/_modifier_path", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_petrified", "_modifiers/generics/_modifier_petrified", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_petrified_status_efx", "_modifiers/generics/_modifier_petrified_status_efx", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_phase", "_modifiers/generics/_modifier_phase", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_pull", "_modifiers/generics/_modifier_pull", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_restrict", "_modifiers/generics/_modifier_restrict", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_root", "_modifiers/generics/_modifier_root", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_silence", "_modifiers/generics/_modifier_silence", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_stun", "_modifiers/generics/_modifier_stun", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_tracking", "_modifiers/generics/_modifier_tracking", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_truesight", "_modifiers/generics/_modifier_truesight", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_turn_disabled", "_modifiers/generics/_modifier_turn_disabled", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_unslowable", "_modifiers/generics/_modifier_unslowable", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("_modifier_untargetable", "_modifiers/generics/_modifier_untargetable", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("orb_bleed__modifier", "_modifiers/orbs/orb_bleed__modifier", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("orb_bleed_debuff", "_modifiers/orbs/orb_bleed_debuff", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("orb_cold__modifier", "_modifiers/orbs/orb_cold__modifier", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("orb_cold_debuff_efx", "_modifiers/orbs/orb_cold_debuff_efx", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("orb_cold_debuff", "_modifiers/orbs/orb_cold_debuff", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("status_bar_bleed", "_modifiers/orbs/status_bar_bleed", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("status_bar_cold", "_modifiers/orbs/status_bar_cold", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("status_bar_cold_max", "_modifiers/orbs/status_bar_cold_max", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("status_bar_cold_max_efx", "_modifiers/orbs/status_bar_cold_max_efx", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("status_bar_curse", "_modifiers/orbs/status_bar_curse", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("status_bar_curse_max", "_modifiers/orbs/status_bar_curse_max", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("status_bar_curse_max_efx", "_modifiers/orbs/status_bar_curse_max_efx", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("orb_holy__modifier", "_modifiers/orbs/orb_holy__modifier", LUA_MODIFIER_MOTION_NONE)

require("internal/muken_events")
require("internal/rank_system")

-- INIT

	function base_hero:Spawn()
    if not IsServer() then return end

    self.hero = self:GetCaster()
    self.hero_data = self.hero:GetHeroData()
    self.stats_lv_limit = {["str"] = 30, ["agi"] = 30, ["int"] = 30, ["vit"] = 30}
    self.rank_max_rand = 24

    if self:IsTrained() == false then self:UpgradeAbility(true) end

    if self.hero:GetUnitName() == "strider_shadow" then
      local stats_list = LoadKeyValues("scripts/npc/npc_units_custom.txt")
      local abilities_stats = {
        ["str"] = self.hero:FindAbilityByName("_ability_str"),
        ["agi"] = self.hero:FindAbilityByName("_ability_agi"),
        ["int"] = self.hero:FindAbilityByName("_ability_int"),
        ["vit"] = self.hero:FindAbilityByName("_ability_vit")
      }
    
      for name, table in pairs(stats_list) do
        if name == self.hero:GetUnitName() then
          for info, stats in pairs(table) do
            if info == "Stats" then
              for stat, value in pairs(stats) do
                abilities_stats[stat]:SetLevel(value)
              end
              return
            end
          end
        end
      end
    end
	end

  function base_hero:GetIntrinsicModifierName()
		return "base_hero_mod"
	end

  function base_hero:OnUpgrade()
    if self.hero:IsHero() == false then return end
		if self.hero:IsIllusion() then return end

		if self:GetLevel() == 1 then
      self:ResetData()
      self.ability_points = self.hero_data.ability_points

      Timers:CreateTimer(0.1, function()
        self.hero:SetAbilityPoints(self.ability_points)
      end)

      for team = DOTA_TEAM_CUSTOM_MIN, DOTA_TEAM_CUSTOM_MIN + 3 do
        if self.hero:GetTeamNumber() == team then
          Timers:CreateTimer(team, function()
            self.hero:RemoveAbilityByHandle(self.hero:FindAbilityByName("ability_capture"))
            self.hero:RemoveAbilityByHandle(self.hero:FindAbilityByName("abyssal_underlord_portal_warp"))
            if INITIAL_XP > 0 then self.hero:AddExperience(INITIAL_XP, 0, false, false) end
          end)
        end
      end
		end
	end

  function base_hero:ResetData()
    self.stat_points = 0
    self.bonus_level = {str = 0, agi = 0, int = 0, vit = 0}
    self:LoadBaseStats()

    self.abilities_name = GetAbilitiesList(self.hero)
    self.ranks_exception = self:GetRanksException()
    self.rank_points = 0
    self.max_level = 0
    self.ability_points = 0

    self.chosen_path = {Path_1 = false, Path_2 = false, Path_3 = false}
    self.path_points = 0
  end

-- STAT SYSTEM

  function base_hero:LoadBaseStats()
    for stat, types_table in pairs(self.hero_data.stats) do
      for type, value in pairs(types_table) do
        if type == "base" then
          local ability_stat = self.hero:FindAbilityByName("_ability_"..string.lower(stat))
          if ability_stat then ability_stat:SetLevel(value) end
        else
          self.bonus_level[string.lower(stat)] = value
        end
      end
    end
  end

  function base_hero:GetRanksException()
    local name = self.hero:GetHeroName()
    local team = self.hero:GetHeroTeam()
    local data = LoadKeyValues("scripts/vscripts/heroes/"..team.."/"..name.."/"..name..".txt")
    local result = {}

    for ability_name, ability_data in pairs(data) do
      if ability_name ~= "Version" then
        local exception = true

        for k, v in pairs(ability_data) do
          if k == "AbilityTextureName" then
            exception = false
          end
        end
  
        result[ability_name] = exception        
      end
    end

    return result
  end

  function base_hero:ApplyStatBonusLevel()
		local level = self.hero:GetLevel()

    for stat, value in pairs(self.bonus_level) do
      local up = math.floor(value)
      local old = math.fmod(value, 1) * (level - 1)
      local new = math.fmod(value, 1) * level
      if math.floor(new + 0.01) - math.floor(old + 0.01) > 0 then up = up + 1 end

      local ability_stat = self.hero:FindAbilityByName("_ability_"..stat)
      if ability_stat then ability_stat:SetLevel(ability_stat:GetLevel() + up) end
    end
  end

  function base_hero:UpgradeStat(stat)
    local ability_stat = self.hero:FindAbilityByName("_ability_"..string.lower(stat))
    if ability_stat then
      ability_stat:UpgradeAbility(true)
      self:UpdateStatPoints(-1, stat)
    end
  end

  function base_hero:UpdatePanoramaPoints(upgraded_stat)
    if self.hero:IsHero() == false then return end
    if self.hero:IsIllusion() then return end

    local player = self.hero:GetPlayerOwner()
    if (not player) then return end

    local stats = {STR = false, AGI = false, INT = false, VIT = false}

    for stat, bool in pairs(stats) do
      stats[stat] = self.stat_points > 0
    end

    -- stats[stat] = ability_stat:GetLevel() < self.stats_lv_limit[string.lower(stat)] + (self.hero:GetLevel() * 4) and self.stat_points > 0

    CustomGameEventManager:Send_ServerToPlayer(player, "update_stats_point_from_lua", {
      total_points = self.stat_points, stats = stats, upgraded_stat = upgraded_stat
    })
  end

  function base_hero:AddPermanentStat(stats, amount)
    for _,stat in pairs(stats) do
      self.stats_lv_limit[stat] = self.stats_lv_limit[stat] + amount
      local ability_stat = self.hero:FindAbilityByName("_ability_"..stat)
      if ability_stat then ability_stat:SetLevel(ability_stat:GetLevel() + amount) end
    end
  end

-- RANK SYSTEM

  function base_hero:UpgradeRank(skill_name, tier, path)
    local special_kv_modifier = self.hero:FindModifierByName(self.hero:GetHeroName().."_special_values")
    if special_kv_modifier == nil then return end

    local skill_id = self:GetSkillID(skill_name)
    tier = tonumber(tier)
    path = tonumber(path)

    special_kv_modifier:LearnRank(skill_id, tier, path)

    local ability = self.hero:FindAbilityByName(self.abilities_name[skill_id])
    ability:SetLevel(ability:GetLevel() + tier)
    self:UpdateRankPoints(-tier)

    SendOverheadEventMessage(nil, OVERHEAD_ALERT_SHARD, self.hero, tier, self.hero)
  end

  function base_hero:UpdatePanoramaRanksByName(player, skill_name)
		if (not player) then return end

    local hero_name = self.hero:GetHeroName()
    local skill_id = self:GetSkillID(skill_name)
    if skill_id == nil then return end

    local list = {}

    for tier = 1, 3, 1 do
      list[tier] = {}
      for path = 1, 2, 1 do
        list[tier][path] = self:GetRankState(skill_id, tier, path)
      end
    end

    local skill_level = 0
    if self.hero:FindAbilityByName(skill_name):IsTrained() then
      skill_level = self.hero:FindAbilityByName(skill_name):GetLevel() + 5
      if skill_id == 6 then skill_level = skill_level + 3 end
    end

		CustomGameEventManager:Send_ServerToPlayer(player, "ranks_from_lua", {
      hero_name = hero_name, skill_name = skill_name, skill_id = skill_id, skill_level = skill_level, table = list
    })
	end

  function base_hero:GetSkillID(skill_name)
    for id, name in pairs(self.abilities_name) do
      if name == skill_name then
        return id
      end
    end
  end

  function base_hero:GetRankState(skill_id, tier, path)
    if self.hero:HasRank(skill_id, tier, path) then return "StateUpgraded" end
    if self:IsRankAvailable(skill_id, tier, path) then return "StateAvailable" end
    return "StateDisabled"
  end

  function base_hero:IsRankAvailable(skill_id, tier, path)
    if self.rank_points < tier then return false end
    if self.hero:FindAbilityByName(self.abilities_name[skill_id]):IsTrained() == false then return false end

    for i = 1, 2, 1 do
      if path ~= i and self.hero:HasRank(skill_id, tier, i) then
        return false
      end
    end

    return true
  end

  function base_hero:GetProgressBarInfo()
    local style = "mana"

    if self.hero:HasModifier("ancient_u_modifier_passive") then
      style = "energy"
    end

    return {
      entity = self.hero:entindex(),
      points = self.rank_points,
      rank_level = self:GetRankLevel(),
      max_level = self.max_level,
      style = style
    }
  end

  function base_hero:GetRankLevel()
    local level = 0

    for skill_id = 1, 6, 1 do
      for tier = 1, 3, 1 do
        for path = 1, 2, 1 do
          if self.hero:HasRank(skill_id, tier, path) then
            level = level + tier
          end
        end
      end
    end

    return level
  end

-- HERO LEVEL UP

	function base_hero:OnHeroLevelUp()
		local level = self.hero:GetLevel()
    if self.hero:IsHero() == false then return end
		if self.hero:IsIllusion() then return end

    self.hero:SetAbilityPoints(self.ability_points)
    self:ApplyStatBonusLevel()

    if level == 2 or level == 4 or level == 6 then
      self:UpdateAbilityPoints(1)
    end

		if level == 10 then
			local ultimate = self.hero:FindAbilityByName(self.abilities_name[6])
			if ultimate then
				if ultimate:IsTrained() == false then
					ultimate:UpgradeAbility(true)
				end
			end
		end

    if level == 20 or level == 30 then
      self:UpdatePathPoints(1)
    end

    local mult = 1
    if level > 20 then mult = 2 end

    if level % 10 ~= 0 then
      if RandomInt(1, 2) == 1 or self.max_level + mult > self.rank_max_rand then
        self:UpdateStatPoints(5 * mult, "nil")
      else
        self.max_level = self.max_level + mult
        self:UpdateRankPoints(1 * mult)
      end      
    end

    local bot_script = self.hero:FindModifierByName("_general_script")
    if bot_script then bot_script:ConsumeAllPoints() end
	end

	function base_hero:OnAbilityUpgrade(ability)
		if ability:GetCaster() == self.hero then
      self:UpdateAbilityPoints(-1)
    end
	end

	function base_hero:UpdateAbilityPoints(points)
		self.ability_points = self.ability_points + points
		self.hero:SetAbilityPoints(self.ability_points)

		for i = 1, 5, 1 do
			local skill = self.hero:FindAbilityByName(self.abilities_name[i])
			if skill then
				if skill:IsTrained() == false then
					--skill:SetHidden(self.ability_points < 1)
				end
			end
		end

    self:UpdatePanoramaRankWindow()
	end

  function base_hero:UpdateStatPoints(points, stat)
		self.stat_points = self.stat_points + points
    self:UpdatePanoramaPoints(stat)
	end

  function base_hero:UpdateRankPoints(points)
		self.rank_points = self.rank_points + points
    self:UpdatePanoramaRankWindow()
    self:UpdatePanoramaProgressBar()
	end

  function base_hero:UpdatePathPoints(points)
		self.path_points = self.path_points + points
    self:UpdatePanoramaPathWindow()
	end

  function base_hero:UpdatePanoramaRankWindow()
    CustomGameEventManager:Send_ServerToAllClients("update_rank_window_from_lua", {entity = self.hero:entindex()})    
	end

  function base_hero:UpdatePanoramaProgressBar()
    CustomGameEventManager:Send_ServerToAllClients("update_bar_from_lua", self:GetProgressBarInfo())
	end

  function base_hero:UpdatePanoramaPathWindow()
    if self.hero:IsHero() == false then return end
    if self.hero:IsIllusion() then return end

    local player = self.hero:GetPlayerOwner()
    if (not player) then return end

    CustomGameEventManager:Send_ServerToPlayer(player, "update_path_window_from_lua", {
      path_states = self.chosen_path, path_points = self.path_points
    })
	end

-- PATH SYSTEM

  function base_hero:UpgradePath(path)
    self.chosen_path[path] = true

    if path == "Path_1" then
      --self.rank_max_rand = 30
      self:UpdateAbilityPoints(1)
    end

    if path == "Path_2" then
      self.max_level = self.max_level + 6
      self:UpdateRankPoints(6)
    end

    if path == "Path_3" then
      self:UpdateStatPoints(30, "nil")
    end

    self:UpdatePathPoints(-1)
  end